// src/services/handlers/flujoHandler.js
import whatsappService from '../whatsappService.js';
import flowRouter from '../../../data/flowRouter.js';
import { encontrarOpcionParecida } from '../../utils/textFormatter.js';
import { sendWelcomeMenu } from './menuHandler.js';
import puntosVentaPorCiudad from '../../../data/puntosVentaPorCiudad.js';
import { setEstado } from '../../utils/stateManager.js';

export function encontrarFlujoPorIntencion(intencion) {
  const flujos = Object.values(flowRouter || {});
  return flujos.find(f => f.intencion === intencion);
}

export function obtenerMensajePuntosVenta(ciudad) {
  const clave = ciudad.trim().toLowerCase();
  const tiendas = puntosVentaPorCiudad[clave];

  if (!tiendas) {
    return `üòï Lo siento, no tenemos puntos de venta registrados en *${ciudad}*. Puedes intentar con otra ciudad.`;
  }

  return `üè¨ *Puntos de venta en ${ciudad.charAt(0).toUpperCase() + ciudad.slice(1)}:*\n\n${tiendas.map(t => `- ${t}`).join('\n')}`;
}

export async function ejecutarFlujoConversacional(userId, flujo) {
  await whatsappService.sendMessage(userId, `üìù *${flujo.nombre}*`);
  await whatsappService.sendMessage(userId, flujo.pregunta);

  if (flujo.opciones?.length) {
    if (flujo.opciones.length <= 3) {
      const botones = flujo.opciones.map((opt, idx) => ({
        type: 'reply',
        reply: { id: `flujo_${flujo.step}_opt_${idx}`, title: opt }
      }));
      await whatsappService.sendInteractiveButtons(userId, "Elige una opci√≥n:", botones);
    } else {
      const rows = flujo.opciones.map((opt, idx) => ({
        id: `flujo_${flujo.step}_opt_${idx}`,
        title: opt.slice(0, 24)
      }));
      await whatsappService.sendListMessage(userId, {
        header: `üìã ${flujo.nombre}`,
        body: flujo.pregunta,
        footer: "Selecciona una opci√≥n para continuar.",
        buttonText: "Ver opciones",
        sections: [{ title: "Opciones disponibles", rows }]
      });
    }
  }

  await setEstado(userId, 'flujo', flujo.step, { flujo_actual: flujo });
}

export async function resolverFlujo(userId, input, estado) {
  const flujo = estado.flujo_actual;
  const opciones = flujo.opciones || [];

  let opcionElegida = input;

  if (opciones.length > 0) {
    const index = encontrarOpcionParecida(opciones, input);
    if (index === -1) {
      await whatsappService.sendMessage(userId, "‚ùå Opci√≥n no v√°lida. Intenta seleccionar desde el men√∫.");
      return;
    }
    opcionElegida = opciones[index];
    await whatsappService.sendMessage(userId, `‚úÖ Has seleccionado: *${opcionElegida}*`);
  } else {
    await whatsappService.sendMessage(userId, `‚úÖ Has escrito: *${opcionElegida}*`);
  }

  if (flowRouter[flujo.step]) {
    await flowRouter[flujo.step](userId, opcionElegida, whatsappService);
  } else {
    await whatsappService.sendMessage(userId, "‚ö†Ô∏è Este flujo a√∫n no est√° configurado.");
  }

  await sendWelcomeMenu(userId);
  await setEstado(userId, 'inicio', 'menu_principal');
}

export async function resolverSeleccionFlujo(userId, optionId, estado) {
  const flujo = estado?.flujo_actual;
  if (!flujo) {
    await whatsappService.sendMessage(userId, "‚ö†Ô∏è No tengo contexto del flujo actual. Escribe *menu* para empezar de nuevo.");
    return;
  }

  const partes = optionId.split('_');
  const index = parseInt(partes.at(-1));
  const opciones = flujo.opciones || [];
  const opcionElegida = opciones[index];

  if (!opcionElegida || typeof opcionElegida !== 'string') {
    console.warn(`‚ö†Ô∏è Opci√≥n inv√°lida: index ${index} en flujo "${flujo.step}".`);
    await whatsappService.sendMessage(userId, "‚ùå Hubo un problema con tu selecci√≥n. Intenta nuevamente o escribe *menu*.");
    return;
  }

  await whatsappService.sendMessage(userId, `‚úÖ Has seleccionado: *${opcionElegida}*`);

  if (["Producto equivocado", "Producto da√±ado", "Pedido incompleto"].includes(opcionElegida)) {
    if (opcionElegida === "Producto equivocado") {
      await whatsappService.sendMessage(userId, "üì¶ Parece que recibiste un producto diferente al que pediste. Por favor comp√°rtenos una foto del producto recibido.");
      await setEstado(userId, 'reclamo', 'esperando_foto_equivocado');
    }

    if (opcionElegida === "Producto da√±ado") {
      await whatsappService.sendMessage(userId, "üò• Vaya, recibiste un producto da√±ado. Por favor env√≠anos una foto o video.");
      await setEstado(userId, 'reclamo', 'esperando_foto_danado');
    }

    if (opcionElegida === "Pedido incompleto") {
      await whatsappService.sendMessage(userId, "üìù Ind√≠canos qu√© producto falt√≥ en tu pedido.");
      await setEstado(userId, 'reclamo', 'esperando_texto_incompleto');
    }

    return;
  }

  const claveRespuesta = 'respuesta_' + opcionElegida
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9]/gi, "_")
    .replace(/_+/g, "_")
    .replace(/^_|_$/g, "");

  const respuesta = flujo[claveRespuesta];

  if (respuesta) {
    const mensajes = Array.isArray(respuesta) ? respuesta : [respuesta];
    for (const mensaje of mensajes) {
      await whatsappService.sendMessage(userId, mensaje);
    }
  } else if (flowRouter[flujo.step]) {
    await flowRouter[flujo.step](userId, opcionElegida, whatsappService);
  } else {
    await whatsappService.sendMessage(userId, "‚ö†Ô∏è Este flujo a√∫n no tiene acci√≥n configurada.");
  }

  await sendWelcomeMenu(userId);
  await setEstado(userId, 'inicio', 'menu_principal');
}
